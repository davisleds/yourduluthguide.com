<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Top 10 best restaurants near Duluth, Minnesota. Discover the highest-rated dining experiences with reviews, ratings, and photos.">
    <meta name="keywords" content="best restaurants Duluth MN, top restaurants Duluth, highest rated restaurants Duluth, Duluth dining guide">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Top 10 Best Restaurants Near Duluth Minnesota | YourDuluthGuide">
    <meta property="og:description" content="Top 10 best restaurants near Duluth, Minnesota. Discover the highest-rated dining experiences with reviews, ratings, and photos.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://duluthguide.com/restaurants.html">
    <meta property="og:image" content="https://duluthguide.com/logo.svg">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/GoogleIcon.png">
    <link rel="shortcut icon" type="image/png" href="/GoogleIcon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/GoogleIcon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/GoogleIcon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/GoogleIcon.png">
    
    <title>Top 10 Best Restaurants Near Duluth Minnesota | YourDuluthGuide</title>
    
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Maps API - Add your API key here: https://developers.google.com/maps/documentation/javascript/get-api-key -->
    <!-- For production, replace YOUR_API_KEY with your actual Google Maps API key -->
    <!-- If you don't have an API key, the map will use a Google Maps-like fallback -->
    <script>
        // Try to load Google Maps API, fallback to Leaflet if it fails
        var useGoogleMaps = true;
        var googleMapsKey = 'YOUR_API_KEY'; // Replace with your Google Maps API key
        var leafletRequested = false;
        var leafletCssLoaded = false;
        window.__leafletLoaded = window.__leafletLoaded || false;
        window.__initMapPending = window.__initMapPending || false;
        
        function loadGoogleMapsScript() {
            var script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=' + googleMapsKey + '&callback=initGoogleMap';
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                useGoogleMaps = false;
                loadLeafletAssets();
            };
            document.head.appendChild(script);
        }
        
        function injectLeafletScript(fallback) {
            var scriptId = fallback ? 'leaflet-script-fallback' : 'leaflet-script';
            if (document.getElementById(scriptId)) return;
            
            var leafletScript = document.createElement('script');
            leafletScript.id = scriptId;
            leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            leafletScript.async = true;
            leafletScript.onload = function() {
                window.__leafletLoaded = true;
                if (typeof initMap === 'function') {
                    initMap();
                } else {
                    window.__initMapPending = true;
                }
            };
            leafletScript.onerror = function() {
                if (!fallback) {
                    console.error('Leaflet script failed, retrying without attributes.');
                    injectLeafletScript(true);
                } else {
                    console.error('Leaflet script failed to load.');
                }
            };
            document.head.appendChild(leafletScript);
        }
        
        function loadLeafletAssets() {
            if (leafletRequested) return;
            leafletRequested = true;
            useGoogleMaps = false;
            
            var leafletCss = document.createElement('link');
            leafletCss.rel = 'stylesheet';
            leafletCss.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
            leafletCss.onload = function() {
                leafletCssLoaded = true;
                injectLeafletScript(false);
            };
            leafletCss.onerror = function() {
                console.error('Leaflet CSS failed to load; continuing without it (map may appear blank).');
                injectLeafletScript(false);
            };
            document.head.appendChild(leafletCss);
            
            // Safety net in case onload doesn't fire (cached resources)
            setTimeout(function() {
                if (!leafletCssLoaded) {
                    injectLeafletScript(false);
                }
            }, 500);
        }
        
        if (googleMapsKey && googleMapsKey !== 'YOUR_API_KEY') {
            loadGoogleMapsScript();
        } else {
            loadLeafletAssets();
        }
    </script>
    
    <style>
        .restaurants-page {
            padding: 120px 0 60px;
            background: var(--color-fog-white);
            min-height: 100vh;
        }
        
        .restaurants-header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 0 20px;
        }
        
        .restaurants-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-navy);
            margin-bottom: 1rem;
        }
        
        .restaurants-header p {
            font-size: 1.1rem;
            color: #64748b;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-container {
            max-width: 1200px;
            margin: 0 auto 3rem;
            padding: 0 20px;
        }
        
        .restaurant-search-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .restaurant-search-bar {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            width: 100%;
            flex: 1;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        
        .restaurant-search-bar:focus {
            outline: none;
            border-color: var(--color-navy);
            box-shadow: 0 0 0 3px rgba(0, 41, 107, 0.1);
        }
        
        .restaurant-search-btn {
            background: var(--color-navy);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0;
            width: 60px;
            height: 60px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
            flex-shrink: 0;
        }
        
        .restaurant-search-btn:hover {
            background: var(--color-copper);
        }
        
        .restaurant-search-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .restaurants-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 2rem;
            align-items: flex-start;
        }
        
        .restaurants-list {
            flex: 1;
            min-width: 0;
        }
        
        .restaurant-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            margin-bottom: 1.5rem;
            height: 200px;
        }
        
        .restaurant-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .restaurant-card-image {
            width: 240px;
            min-width: 240px;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        
        .restaurant-card-body {
            padding: 1.25rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        
        .restaurant-card-number {
            font-size: 1rem;
            font-weight: 700;
            color: var(--color-navy);
            margin-right: 0.5rem;
        }
        
        .restaurant-card-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--color-navy);
            margin-bottom: 0.5rem;
            line-height: 1.3;
            display: flex;
            align-items: center;
        }
        
        .restaurant-card-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }
        
        .restaurant-card-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.95rem;
            color: #333;
        }
        
        .restaurant-card-rating .stars {
            color: #f97316;
            font-size: 1rem;
        }
        
        .restaurant-card-price {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .restaurant-card-location-info {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }
        
        .restaurant-card-cuisine {
            background: #f1f5f9;
            color: var(--color-navy);
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .restaurant-card-description {
            color: #64748b;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }
        
        .restaurant-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: auto;
        }

        .restaurant-card-voting {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.1rem;
            padding: 1rem;
            width: fit-content;
            flex-shrink: 0;
        }

        .restaurant-card-voting .vote-button {
            background: transparent;
            border: none;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #9ca3af;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .restaurant-card-voting .vote-button svg {
            width: 100%;
            height: 100%;
        }

        .restaurant-card-voting .vote-button:hover {
            color: #d1d5db;
        }

        .restaurant-card-voting .vote-button.voted-up {
            color: var(--color-navy);
        }

        .restaurant-card-voting .vote-button.voted-down {
            color: var(--color-navy);
        }

        .restaurant-card-voting .vote-count {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--color-navy);
            text-align: center;
            min-width: 35px;
            line-height: 1.2;
        }

        .restaurant-card-voting .vote-count.positive {
            color: var(--color-navy);
        }

        .restaurant-card-voting .vote-count.negative {
            color: var(--color-navy);
        }
        
        .map-container {
            width: 400px;
            min-width: 400px;
            position: sticky;
            top: 20px;
            height: calc(100vh - 40px);
            max-height: 800px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .map-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .map-placeholder {
            width: 100%;
            height: 100%;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 0.95rem;
        }
        
        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
            border-radius: 12px;
        }
        
        /* Google Maps styling */
        .gm-style {
            font-family: 'Inter', sans-serif !important;
        }
        
        .gm-style .gm-style-iw-c {
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .gm-style .gm-style-iw-d {
            overflow: hidden !important;
        }
        
        .gm-style .gm-style-iw-t::after {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .gm-style .gm-style-iw-tc {
            margin-top: -1px;
        }
        
        /* Custom marker styling */
        .gm-style-iw {
            font-family: 'Inter', sans-serif;
        }
        
        .no-results {
            text-align: center;
            padding: 3rem 1rem;
            color: #64748b;
        }
        
        .no-results h3 {
            font-size: 1.5rem;
            color: var(--color-navy);
            margin-bottom: 0.5rem;
        }
        
        .results-count {
            text-align: center;
            color: #64748b;
            margin-bottom: 2rem;
            font-size: 1rem;
        }
        
        .results-count strong {
            color: var(--color-navy);
        }
        
        .pagination-container {
            margin-top: 3rem;
            display: flex;
            justify-content: center;
        }
        
        .pagination {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .pagination-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--color-navy);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: var(--color-navy);
            color: white;
            border-color: var(--color-navy);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-numbers {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .page-number {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: var(--color-navy);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }
        
        .page-number:hover {
            background: var(--color-lake-mist);
            border-color: var(--color-navy);
        }
        
        .page-number.active {
            background: var(--color-navy);
            color: white;
            border-color: var(--color-navy);
        }
        
        @media (max-width: 768px) {
            .restaurants-header h1 {
                font-size: 2rem;
            }
            
            .restaurants-container {
                flex-direction: column;
            }
            
            .map-container {
                display: none;
            }
            
            .restaurant-card {
                flex-direction: column;
                height: auto;
                position: relative;
            }
            
            .restaurant-card-image {
                width: 100%;
                min-width: 100%;
                height: 200px;
            }
            
            .restaurant-card-voting {
                position: absolute;
                top: 1rem;
                right: 1rem;
                padding: 0.5rem;
            }
            
            .restaurant-card-voting .vote-button {
                font-size: 1.3rem;
            }
            
            .restaurant-card-voting .vote-count {
                font-size: 1.2rem;
            }
            
            .pagination {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .page-numbers {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="nav-container">
                <div class="nav-logo">
                    <h1><a href="index.html">YourDuluthGuide</a></h1>
                </div>
                <ul class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="restaurants.html">All Restaurants</a></li>
                    <li><a href="dining.html">Dining</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Restaurants Page Content -->
    <section class="restaurants-page">
        <div class="restaurants-header">
            <h1>Top 10 Best Restaurants Near Duluth Minnesota</h1>
            <p>Discover the highest-rated dining experiences with reviews, ratings, and photos from over 100 local restaurants</p>
        </div>
        
        <div class="search-container">
            <div class="restaurant-search-wrapper">
                <input 
                    type="text" 
                    id="restaurantSearch" 
                    class="restaurant-search-bar" 
                    placeholder="Search restaurants by name, cuisine, or location..."
                    autocomplete="off"
                >
                <button class="restaurant-search-btn" type="button" aria-label="Search" id="searchButton">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="restaurants-container">
            <div class="restaurants-list">
                <div id="resultsCount" class="results-count"></div>
                <div id="restaurantsGrid" class="restaurants-list">
                    <!-- Restaurants will be loaded here -->
                </div>
                <div id="noResults" class="no-results" style="display: none;">
                    <h3>No restaurants found</h3>
                    <p>Try adjusting your search terms or browse all restaurants below.</p>
                </div>
                
                <!-- Pagination Controls -->
                <div id="pagination" class="pagination-container" style="display: none;">
                    <div class="pagination">
                        <button id="prevPage" class="pagination-btn" disabled>Previous</button>
                        <div id="pageNumbers" class="page-numbers"></div>
                        <button id="nextPage" class="pagination-btn">Next</button>
                    </div>
                </div>
            </div>
            
            <!-- Map Container -->
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>DuluthGuide</h3>
                    <p>Your calm, trustworthy guide to Duluth restaurants and local travel.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="restaurants.html">All Restaurants</a></li>
                        <li><a href="dining.html">Dining</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>© 2025 DuluthGuide · All Rights Reserved</p>
            </div>
        </div>
    </footer>

    <script src="restaurants-data.js"></script>
    <script>
        // Pagination state
        var currentPage = 1;
        var restaurantsPerPage = 10;
        var allFilteredRestaurants = [];
        
        // Map instance
        var map = null;
        var markers = [];
        var googleMarkers = [];
        
        // Track if user has manually interacted with the map (zoomed or panned)
        var mapUserInteracted = false;
        
        if (window.__initMapPending && typeof initMap === 'function') {
            window.__initMapPending = false;
            initMap();
        }
        
        // Location coordinates for different areas in Duluth
        var locationCoordinates = {
            'Downtown': { lat: 46.7867, lng: -92.1005 },
            'Canal Park': { lat: 46.7756, lng: -92.0919 },
            'Miller Hill': { lat: 46.8131, lng: -92.1831 },
            'Chester Creek': { lat: 46.8006, lng: -92.0831 },
            'Central Entrance': { lat: 46.8067, lng: -92.1333 },
            'London Road': { lat: 46.7933, lng: -92.0917 },
            'East Duluth': { lat: 46.7917, lng: -92.0667 },
            'West Duluth': { lat: 46.7750, lng: -92.1333 },
            'West Central Entrance': { lat: 46.8083, lng: -92.1500 },
            'North Shore': { lat: 46.8167, lng: -92.0833 }
        };
        
        // Geocoding cache
        var geocodeCache = {};
        var geocodingInProgress = {};

        // Hard-coded coordinate overrides for restaurants that geocode poorly
        // Values are approximate but place the pin on the correct building.
        var restaurantCoordinateOverrides = {
            'Northern Waters Smokehaus': { lat: 46.7795, lng: -92.0936 }
        };
        
        // Load geocode cache from localStorage
        function loadGeocodeCache() {
            try {
                var cached = localStorage.getItem('restaurantGeocodeCache');
                if (cached) {
                    geocodeCache = JSON.parse(cached);
                }
            } catch (e) {
                console.warn('Failed to load geocode cache:', e);
            }
        }
        
        // Save geocode cache to localStorage
        function saveGeocodeCache() {
            try {
                localStorage.setItem('restaurantGeocodeCache', JSON.stringify(geocodeCache));
            } catch (e) {
                console.warn('Failed to save geocode cache:', e);
            }
        }
        
        // Geocode address using Google Geocoding API
        function geocodeWithGoogle(address, callback) {
            if (typeof google === 'undefined' || !google.maps || !google.maps.Geocoder) {
                callback(null);
                return;
            }
            
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: address }, function(results, status) {
                if (status === 'OK' && results && results[0]) {
                    var location = results[0].geometry.location;
                    var coords = {
                        lat: location.lat(),
                        lng: location.lng()
                    };
                    console.log('Geocoded (Google):', address, '->', coords);
                    callback(coords);
                } else {
                    console.warn('Google geocoding failed for:', address, 'Status:', status);
                    callback(null);
                }
            });
        }
        
        // Geocode address using Nominatim (OpenStreetMap) - free alternative
        function geocodeWithNominatim(address, callback) {
            var encodedAddress = encodeURIComponent(address);
            var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodedAddress + '&limit=1&addressdetails=1';
            
            fetch(url, {
                headers: {
                    'User-Agent': 'YourDuluthGuide/1.0 (https://yourduluthguide.com)'
                }
            })
            .then(function(response) {
                if (!response.ok) throw new Error('Geocoding failed: ' + response.status);
                return response.json();
            })
            .then(function(data) {
                if (data && data.length > 0) {
                    var coords = {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                    console.log('Geocoded (Nominatim):', address, '->', coords);
                    callback(coords);
                } else {
                    console.warn('Nominatim geocoding returned no results for:', address);
                    callback(null);
                }
            })
            .catch(function(error) {
                console.warn('Nominatim geocoding failed for:', address, 'Error:', error);
                callback(null);
            });
        }
        
        // Normalize address for cache key (remove extra spaces, normalize case)
        function normalizeAddress(address) {
            return address.trim().replace(/\s+/g, ' ');
        }
        
        // Geocode an address (tries Google first, then Nominatim)
        function geocodeAddress(address, callback) {
            var normalizedAddress = normalizeAddress(address);
            
            // Check cache first
            if (geocodeCache[normalizedAddress]) {
                callback(geocodeCache[normalizedAddress]);
                return;
            }
            
            // Check if already geocoding this address
            if (geocodingInProgress[normalizedAddress]) {
                geocodingInProgress[normalizedAddress].push(callback);
                return;
            }
            
            geocodingInProgress[normalizedAddress] = [callback];
            
            var callbacks = geocodingInProgress[normalizedAddress];
            
            // Try Google first
            geocodeWithGoogle(address, function(coords) {
                if (coords) {
                    geocodeCache[normalizedAddress] = coords;
                    saveGeocodeCache();
                    delete geocodingInProgress[normalizedAddress];
                    callbacks.forEach(function(cb) { cb(coords); });
                } else {
                    // Fallback to Nominatim
                    geocodeWithNominatim(address, function(coords) {
                        if (coords) {
                            geocodeCache[normalizedAddress] = coords;
                            saveGeocodeCache();
                        }
                        delete geocodingInProgress[normalizedAddress];
                        callbacks.forEach(function(cb) { cb(coords); });
                    });
                }
            });
        }
        
        // Clear geocode cache (useful for debugging or if addresses change)
        function clearGeocodeCache() {
            geocodeCache = {};
            try {
                localStorage.removeItem('restaurantGeocodeCache');
                console.log('Geocode cache cleared');
            } catch (e) {
                console.warn('Failed to clear geocode cache:', e);
            }
        }
        
        // Expose clear function for debugging (can call clearGeocodeCache() in console)
        window.clearGeocodeCache = clearGeocodeCache;
        
        // Get coordinates for a restaurant based on address
        function getRestaurantCoordinates(restaurant) {
            // 1) Use hard-coded overrides first if available
            if (restaurant && restaurant.name && restaurantCoordinateOverrides[restaurant.name]) {
                return restaurantCoordinateOverrides[restaurant.name];
            }

            // Use address if available
            if (restaurant.address && restaurant.address.trim() && restaurant.address !== 'N/A') {
                var address = restaurant.address.trim();
                var normalizedAddress = normalizeAddress(address);
                
                // Check cache first (synchronous)
                if (geocodeCache[normalizedAddress]) {
                    return geocodeCache[normalizedAddress];
                }
                
                // If not in cache, geocode it asynchronously and update map when done
                geocodeAddress(address, function(coords) {
                    if (coords && map) {
                        // Small delay to ensure cache is saved
                        setTimeout(function() {
                            // Refresh map markers with new coordinates
                            refreshMapMarkers();
                        }, 100);
                    }
                });
                
                // Return fallback coordinates while geocoding
            var baseLocation = locationCoordinates[restaurant.location] || locationCoordinates['Downtown'];
            return {
                    lat: baseLocation.lat,
                    lng: baseLocation.lng
                };
            }
            
            // Fallback to location-based coordinates if no address
            var baseLocation = locationCoordinates[restaurant.location] || locationCoordinates['Downtown'];
            return {
                lat: baseLocation.lat,
                lng: baseLocation.lng
            };
        }
        
        // Pre-geocode all restaurant addresses in the background
        function preGeocodeAllRestaurants() {
            if (typeof allRestaurants === 'undefined') {
                return;
            }
            
            // Process restaurants with a delay to avoid overwhelming the geocoding service
            var index = 0;
            var delay = 1100; // 1.1 second delay between requests (respects Nominatim's 1 req/sec limit)
            
            function geocodeNext() {
                if (index >= allRestaurants.length) {
                    return;
        }
                
                var restaurant = allRestaurants[index];
                if (restaurant.address && restaurant.address.trim() && restaurant.address !== 'N/A') {
                    var address = restaurant.address.trim();
                    
                    // Only geocode if not already in cache
                    if (!geocodeCache[address]) {
                        geocodeAddress(address, function(coords) {
                            if (coords) {
                                // Refresh map if it's already initialized
                                if (map) {
                                    refreshMapMarkers();
                                }
                            }
                        });
                    }
                }
                
                index++;
                setTimeout(geocodeNext, delay);
            }
            
            // Start geocoding after a short delay
            setTimeout(geocodeNext, 1000);
        }
        
        // Initialize geocode cache on page load
        loadGeocodeCache();
        
        // Sort restaurants by rating (highest first)
        function sortRestaurantsByRating(restaurants) {
            return restaurants.slice().sort(function(a, b) {
                var ratingA = parseFloat(a.rating) || 0;
                var ratingB = parseFloat(b.rating) || 0;
                // If ratings are equal, sort by number of reviews (higher reviews first)
                if (ratingB === ratingA) {
                    var reviewsA = parseInt(a.reviews.replace(/,/g, '')) || 0;
                    var reviewsB = parseInt(b.reviews.replace(/,/g, '')) || 0;
                    return reviewsB - reviewsA;
                }
                return ratingB - ratingA;
            });
        }
        
        // Render restaurants for current page
        function renderRestaurants() {
            var grid = document.getElementById('restaurantsGrid');
            var noResults = document.getElementById('noResults');
            var resultsCount = document.getElementById('resultsCount');
            var pagination = document.getElementById('pagination');
            
            if (!grid) return;
            
            if (allFilteredRestaurants.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
                resultsCount.textContent = '';
                pagination.style.display = 'none';
                return;
            }
            
            // Calculate pagination
            var totalPages = Math.ceil(allFilteredRestaurants.length / restaurantsPerPage);
            var startIndex = (currentPage - 1) * restaurantsPerPage;
            var endIndex = startIndex + restaurantsPerPage;
            var pageRestaurants = allFilteredRestaurants.slice(startIndex, endIndex);
            
            // Update results count
            var showingStart = startIndex + 1;
            var showingEnd = Math.min(endIndex, allFilteredRestaurants.length);
            resultsCount.innerHTML = 'Showing <strong>' + showingStart + '-' + showingEnd + '</strong> of <strong>' + allFilteredRestaurants.length + '</strong> restaurants';
            
            grid.style.display = 'block';
            noResults.style.display = 'none';
            
            function escapeHtml(text) {
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Render restaurant cards
            grid.innerHTML = pageRestaurants.map(function(restaurant, index) {
                var name = escapeHtml(restaurant.name);
                var cuisine = escapeHtml(restaurant.cuisine);
                var description = escapeHtml(restaurant.description);
                var location = escapeHtml(restaurant.location);
                var restaurantNumber = startIndex + index + 1;
                
                // Split cuisine into tags (limit to 3)
                var cuisineTags = cuisine.split(' • ').slice(0, 3).map(function(tag) {
                    return '<span class="restaurant-card-cuisine">' + escapeHtml(tag.trim()) + '</span>';
                }).join('');
                
                // Generate star rating display
                var ratingNum = parseFloat(restaurant.rating) || 0;
                var fullStars = Math.floor(ratingNum);
                var hasHalfStar = (ratingNum % 1) >= 0.5;
                var emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                var starsHtml = '★'.repeat(fullStars) + (hasHalfStar ? '½' : '') + '☆'.repeat(emptyStars);
                // Replace with actual star characters
                starsHtml = '★★★★★'.substring(0, fullStars) + (hasHalfStar ? '½' : '') + '☆'.repeat(emptyStars);
                
                var phoneParam = restaurant.phone ? '\'' + restaurant.phone.replace(/'/g, "\\'") + '\'' : 'null';
                var websiteParam = restaurant.website ? '\'' + restaurant.website.replace(/'/g, "\\'") + '\'' : 'null';
                var addressParam = restaurant.address ? '\'' + restaurant.address.replace(/'/g, "\\'") + '\'' : 'null';
                var reservationsParam = restaurant.reservations ? '\'' + restaurant.reservations.replace(/'/g, "\\'") + '\'' : 'null';
                var popularDishesParam = restaurant.popularDishes ? '\'' + restaurant.popularDishes.join(',').replace(/'/g, "\\'") + '\'' : 'null';
                var hoursParam = restaurant.hours ? '\'' + encodeURIComponent(JSON.stringify(restaurant.hours)).replace(/'/g, "\\'") + '\'' : 'null';
                
                // Use restaurant image directly (paths are already properly formatted)
                var imagePath = restaurant.image || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop';
                
                return '<div class="restaurant-card" onclick="openRestaurant(\'' +
                    name.replace(/'/g, "\\'") + '\',' +
                    restaurantNumber + ',\'' +
                    restaurant.rating + '\',\'' +
                    restaurant.reviews + '\',\'' +
                    restaurant.price + '\',\'' +
                    cuisine.replace(/'/g, "\\'") + '\',\'' +
                    description.replace(/'/g, "\\'") + '\',\'' +
                    restaurant.image.replace(/'/g, "\\'") + '\',\'' +
                    location.replace(/'/g, "\\'") + '\',' +
                    phoneParam + ',' +
                    websiteParam + ',' +
                    addressParam + ',' +
                    reservationsParam + ',' +
                    popularDishesParam + ',' +
                    hoursParam + ')">' +
                    '<img src="' + imagePath + '" alt="' + name + '" class="restaurant-card-image" loading="lazy" onerror="console.error(\'Image failed to load:\', this.src); this.onerror=null; this.src=\'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=300&fit=crop\';">' +
                    '<div class="restaurant-card-body">' +
                    '<h3 class="restaurant-card-name"><span class="restaurant-card-number">' + restaurantNumber + '.</span>' + name + '</h3>' +
                    '<div class="restaurant-card-meta">' +
                    '<div class="restaurant-card-rating"><span class="stars">★★★★★</span><span>' + restaurant.rating + ' (' + restaurant.reviews + ' reviews)</span></div>' +
                    '</div>' +
                    '<div class="restaurant-card-location-info">' + location + ' • ' + restaurant.price + '</div>' +
                    '<p class="restaurant-card-description">' + description + '</p>' +
                    '<div class="restaurant-card-tags">' + cuisineTags + '</div>' +
                    '</div>' +
                    '<div class="restaurant-card-voting" data-restaurant="' + restaurant.name.replace(/'/g, "\\'") + '" data-restaurant-id="' + restaurant.name.replace(/[^a-zA-Z0-9]/g, '-') + '" onclick="event.stopPropagation();">' +
                    '<button class="vote-button upvote" data-restaurant-name="' + restaurant.name.replace(/"/g, '&quot;').replace(/'/g, '&#39;') + '" data-vote-type="up" aria-label="Upvote this restaurant"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg></button>' +
                    '<span class="vote-count positive" id="vote-' + restaurant.name.replace(/[^a-zA-Z0-9]/g, '-') + '">1</span>' +
                    '<button class="vote-button downvote" data-restaurant-name="' + restaurant.name.replace(/"/g, '&quot;').replace(/'/g, '&#39;') + '" data-vote-type="down" aria-label="Downvote this restaurant"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></button>' +
                    '</div></div>';
            }).join('');
            
            // Update map with restaurant locations (only current page)
            updateMap(pageRestaurants, startIndex);
            
            // Update pagination controls
            updatePagination(totalPages);
            
            // Initialize voting for displayed restaurants
            pageRestaurants.forEach(function(restaurant) {
                initializeRestaurantVoting(restaurant.name);
            });
            
            // Attach event listeners
            attachVoteButtonListeners();
        }
        
        function attachVoteButtonListeners() {
            // Use event delegation - simple and reliable
            var restaurantsContainer = document.getElementById('restaurantsGrid');
            if (!restaurantsContainer) {
                console.warn('restaurantsGrid not found');
                return;
            }
            
            // Remove old listener if exists
            if (restaurantsContainer._voteListenerAttached) {
                restaurantsContainer.removeEventListener('click', restaurantsContainer._voteHandler, true);
            }
            
            // Create handler
            restaurantsContainer._voteHandler = function(e) {
                // Find button - handle clicks on SVG elements
                var target = e.target;
                var button = target.closest('.vote-button');
                
                // If closest didn't work, try traversing up
                if (!button) {
                    var parent = target.parentElement;
                    var depth = 0;
                    while (parent && depth < 5) {
                        if (parent.classList && parent.classList.contains('vote-button')) {
                            button = parent;
                            break;
                        }
                        parent = parent.parentElement;
                        depth++;
                    }
                }
                
                if (!button) return;
                
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                var restaurantName = button.getAttribute('data-restaurant-name');
                var voteType = button.getAttribute('data-vote-type');
                
                if (restaurantName && voteType) {
                    // Decode HTML entities
                    var decodedName = restaurantName
                        .replace(/&quot;/g, '"')
                        .replace(/&#39;/g, "'")
                        .replace(/&amp;/g, '&');
                    handleRestaurantVote(decodedName, voteType, button);
                }
            };
            
            restaurantsContainer.addEventListener('click', restaurantsContainer._voteHandler, true);
            restaurantsContainer._voteListenerAttached = true;
        }
        
        // Restaurant voting functions
        function getRestaurantVoteData(restaurantName) {
            var key = 'restaurant-' + restaurantName + '-votes';
            var stored = localStorage.getItem(key);
            if (stored) {
                var data = JSON.parse(stored);
                // Ensure we have at least 1 upvote (starting score of 1)
                if (data.upvotes === 0 && data.downvotes === 0 && data.userVote === null) {
                    data.upvotes = 1;
                }
                return data;
            }
            return { upvotes: 1, downvotes: 0, userVote: null };
        }
        
        function saveRestaurantVoteData(restaurantName, voteData) {
            var key = 'restaurant-' + restaurantName + '-votes';
            localStorage.setItem(key, JSON.stringify(voteData));
        }
        
        function handleRestaurantVote(restaurantName, voteType, buttonElement) {
            var voteData = getRestaurantVoteData(restaurantName);
            
            // If user already voted the same way, remove the vote
            if (voteData.userVote === voteType) {
                if (voteType === 'up') {
                    voteData.upvotes = Math.max(0, voteData.upvotes - 1);
                } else {
                    voteData.downvotes = Math.max(0, voteData.downvotes - 1);
                }
                voteData.userVote = null;
            } else {
                // Remove previous vote if exists
                if (voteData.userVote === 'up') {
                    voteData.upvotes = Math.max(0, voteData.upvotes - 1);
                } else if (voteData.userVote === 'down') {
                    voteData.downvotes = Math.max(0, voteData.downvotes - 1);
                }
                
                // Add new vote
                if (voteType === 'up') {
                    voteData.upvotes += 1;
                } else {
                    voteData.downvotes += 1;
                }
                voteData.userVote = voteType;
            }
            
            saveRestaurantVoteData(restaurantName, voteData);
            updateRestaurantVoteDisplay(restaurantName, voteData);
        }
        
        function updateRestaurantVoteDisplay(restaurantName, voteData) {
            var safeId = restaurantName.replace(/[^a-zA-Z0-9]/g, '-');
            // Use safeId to find the voting container (most reliable method)
            var votingContainer = document.querySelector('[data-restaurant-id="' + safeId + '"]');
            
            if (!votingContainer) {
                // Fallback: try to find by restaurant name (escape special chars for CSS selector)
                var escapedName = restaurantName.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, '\\$&');
                votingContainer = document.querySelector('[data-restaurant="' + escapedName + '"]');
            }
            
            if (!votingContainer) {
                console.warn('Could not find voting container for:', restaurantName);
                return;
            }
            
            var upButton = votingContainer.querySelector('.vote-button.upvote');
            var downButton = votingContainer.querySelector('.vote-button.downvote');
            var voteCount = document.getElementById('vote-' + safeId);
            
            if (!upButton || !downButton || !voteCount) {
                console.warn('Could not find voting elements for:', restaurantName, { upButton: !!upButton, downButton: !!downButton, voteCount: !!voteCount });
                return;
            }
            
            // Update button states
            upButton.classList.remove('voted-up', 'voted-down');
            downButton.classList.remove('voted-up', 'voted-down');
            
            if (voteData.userVote === 'up') {
                upButton.classList.add('voted-up');
            } else if (voteData.userVote === 'down') {
                downButton.classList.add('voted-down');
            }
            
            // Calculate net score (upvotes - downvotes)
            var netScore = voteData.upvotes - voteData.downvotes;
            voteCount.textContent = netScore;
            
            // Update count color based on positive/negative/zero
            voteCount.classList.remove('positive', 'negative');
            if (netScore > 0) {
                voteCount.classList.add('positive');
            } else if (netScore < 0) {
                voteCount.classList.add('negative');
            } else {
                // netScore is 0, default to positive (green) for neutral
                voteCount.classList.add('positive');
            }
        }
        
        function initializeRestaurantVoting(restaurantName) {
            var voteData = getRestaurantVoteData(restaurantName);
            updateRestaurantVoteDisplay(restaurantName, voteData);
        }
        
        // Update pagination controls
        function updatePagination(totalPages) {
            var pagination = document.getElementById('pagination');
            var prevBtn = document.getElementById('prevPage');
            var nextBtn = document.getElementById('nextPage');
            var pageNumbers = document.getElementById('pageNumbers');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            // Update prev/next buttons
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            // Generate page number buttons
            pageNumbers.innerHTML = '';
            var maxVisiblePages = 7;
            var startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            var endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start if we're near the end
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Show first page if not visible
            if (startPage > 1) {
                var firstBtn = document.createElement('button');
                firstBtn.className = 'page-number';
                firstBtn.textContent = '1';
                firstBtn.onclick = function() { goToPage(1); };
                pageNumbers.appendChild(firstBtn);
                
                if (startPage > 2) {
                    var ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 0.5rem';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            // Show page numbers
            for (var i = startPage; i <= endPage; i++) {
                var pageBtn = document.createElement('button');
                pageBtn.className = 'page-number' + (i === currentPage ? ' active' : '');
                pageBtn.textContent = i;
                pageBtn.onclick = function(page) {
                    return function() { goToPage(page); };
                }(i);
                pageNumbers.appendChild(pageBtn);
            }
            
            // Show last page if not visible
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    var ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 0.5rem';
                    pageNumbers.appendChild(ellipsis);
                }
                
                var lastBtn = document.createElement('button');
                lastBtn.className = 'page-number';
                lastBtn.textContent = totalPages;
                lastBtn.onclick = function() { goToPage(totalPages); };
                pageNumbers.appendChild(lastBtn);
            }
        }
        
        // Go to specific page
        function goToPage(page) {
            var totalPages = Math.ceil(allFilteredRestaurants.length / restaurantsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderRestaurants();
            // Scroll to top of results
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Cuisine category mapping for SEO
        var cuisineCategories = {
            'pizza': { name: 'Pizza', plural: 'Pizza Restaurants', keywords: ['pizza', 'italian pizza', 'neapolitan'] },
            'burger': { name: 'Burgers', plural: 'Burger Restaurants', keywords: ['burger', 'burgers', 'hamburger'] },
            'thai': { name: 'Thai', plural: 'Thai Restaurants', keywords: ['thai', 'thai food'] },
            'italian': { name: 'Italian', plural: 'Italian Restaurants', keywords: ['italian', 'pasta', 'italy'] },
            'mexican': { name: 'Mexican', plural: 'Mexican Restaurants', keywords: ['mexican', 'taco', 'tacos', 'burrito', 'mexico'] },
            'chinese': { name: 'Chinese', plural: 'Chinese Restaurants', keywords: ['chinese', 'china'] },
            'japanese': { name: 'Japanese', plural: 'Japanese Restaurants', keywords: ['japanese', 'sushi', 'hibachi', 'japan'] },
            'indian': { name: 'Indian', plural: 'Indian Restaurants', keywords: ['indian', 'india', 'curry'] },
            'vietnamese': { name: 'Vietnamese', plural: 'Vietnamese Restaurants', keywords: ['vietnamese', 'pho', 'vietnam'] },
            'seafood': { name: 'Seafood', plural: 'Seafood Restaurants', keywords: ['seafood', 'fish', 'lobster', 'crab'] },
            'bbq': { name: 'BBQ', plural: 'BBQ Restaurants', keywords: ['bbq', 'barbecue', 'barbeque', 'smokehouse'] },
            'breakfast': { name: 'Breakfast', plural: 'Breakfast Restaurants', keywords: ['breakfast', 'brunch', 'pancake', 'waffle'] },
            'coffee': { name: 'Coffee', plural: 'Coffee Shops', keywords: ['coffee', 'cafe', 'café', 'espresso'] },
            'ice cream': { name: 'Ice Cream', plural: 'Ice Cream Shops', keywords: ['ice cream', 'gelato', 'frozen yogurt'] },
            'sports bar': { name: 'Sports Bar', plural: 'Sports Bars', keywords: ['sports bar', 'sportsbar', 'bar', 'pub'] },
            'brewery': { name: 'Brewery', plural: 'Breweries', keywords: ['brewery', 'brew', 'beer', 'brewhouse'] },
            'steakhouse': { name: 'Steakhouse', plural: 'Steakhouses', keywords: ['steakhouse', 'steak', 'steaks'] },
            'fine dining': { name: 'Fine Dining', plural: 'Fine Dining Restaurants', keywords: ['fine dining', 'upscale', 'elegant'] }
        };
        
        // Detect cuisine category from search term
        function detectCuisineCategory(searchTerm) {
            var term = searchTerm.toLowerCase().trim();
            
            for (var key in cuisineCategories) {
                var category = cuisineCategories[key];
                for (var i = 0; i < category.keywords.length; i++) {
                    if (term === category.keywords[i] || term.indexOf(category.keywords[i]) !== -1) {
                        return category;
                    }
                }
            }
            
            return null;
        }
        
        // Update page title and meta for SEO
        function updatePageSEO(category, searchTerm) {
            var pageTitle = '';
            var pageDescription = '';
            var headerTitle = '';
            var headerDescription = '';
            
            if (category) {
                // SEO-optimized category page (only for food-related categories)
                pageTitle = 'Locals Guide to 10 Best ' + category.plural + ' in Duluth Minnesota | YourDuluthGuide';
                pageDescription = 'Discover the top rated ' + category.plural.toLowerCase() + ' in Duluth, Minnesota. Find the best ' + category.name.toLowerCase() + ' restaurants with reviews, ratings, and photos.';
                headerTitle = 'Locals Guide to 10 Best ' + category.plural + ' in Duluth Minnesota';
                headerDescription = 'Discover the highest-rated ' + category.plural.toLowerCase() + ' with reviews, ratings, and photos';
                
                // Update URL
                var cuisineSlug = category.name.toLowerCase().replace(/\s+/g, '-');
                if (window.history && window.history.pushState) {
                    var newUrl = window.location.pathname + '?cuisine=' + encodeURIComponent(cuisineSlug);
                    window.history.pushState({ path: newUrl }, '', newUrl);
                }
            } else if (searchTerm) {
                // Generic search results - use Locals Guide format
                var capitalizedTerm = searchTerm.charAt(0).toUpperCase() + searchTerm.slice(1).toLowerCase();
                pageTitle = 'Locals Guide to 10 Best ' + capitalizedTerm + ' Restaurants in Duluth Minnesota | YourDuluthGuide';
                pageDescription = 'Discover the top rated ' + searchTerm.toLowerCase() + ' restaurants in Duluth, Minnesota. Find the best ' + searchTerm.toLowerCase() + ' dining options with reviews, ratings, and photos.';
                headerTitle = 'Locals Guide to 10 Best ' + capitalizedTerm + ' Restaurants in Duluth Minnesota';
                headerDescription = 'Discover the highest-rated ' + searchTerm.toLowerCase() + ' restaurants with reviews, ratings, and photos';
            } else {
                // Default page
                pageTitle = 'Top 10 Best Restaurants Near Duluth Minnesota | YourDuluthGuide';
                pageDescription = 'Top 10 best restaurants near Duluth, Minnesota. Discover the highest-rated dining experiences with reviews, ratings, and photos.';
                headerTitle = 'Top 10 Best Restaurants Near Duluth Minnesota';
                headerDescription = 'Discover the highest-rated dining experiences with reviews, ratings, and photos from over 100 local restaurants';
            }
            
            // Update document title and meta
            document.title = pageTitle;
            var metaDescription = document.querySelector('meta[name="description"]');
            if (metaDescription) {
                metaDescription.setAttribute('content', pageDescription);
            }
            
            // Update Open Graph tags for Google
            var ogTitle = document.querySelector('meta[property="og:title"]');
            if (ogTitle) {
                ogTitle.setAttribute('content', pageTitle);
            }
            var ogDescription = document.querySelector('meta[property="og:description"]');
            if (ogDescription) {
                ogDescription.setAttribute('content', pageDescription);
            }
            
            // Update header
            var headerH1 = document.querySelector('.restaurants-header h1');
            var headerP = document.querySelector('.restaurants-header p');
            if (headerH1) headerH1.textContent = headerTitle;
            if (headerP) headerP.textContent = headerDescription;
        }
        
        // Search function
        function doSearch(skipPageReset) {
            var searchInput = document.getElementById('restaurantSearch');
            var searchTerm = searchInput ? searchInput.value.trim() : '';
            
            if (typeof allRestaurants === 'undefined') {
                var grid = document.getElementById('restaurantsGrid');
                if (grid) {
                    grid.innerHTML = '<div class="no-results"><h3>Error: Restaurant data not loaded</h3><p>Please refresh the page.</p></div>';
                }
                return;
            }
            
            // Reset to page 1 when searching (unless we're restoring a page)
            if (!skipPageReset) {
            currentPage = 1;
            }
            
            // Detect cuisine category
            var category = detectCuisineCategory(searchTerm);
            
            // Update SEO elements
            updatePageSEO(category, searchTerm);
            
            // Filter restaurants
            if (!searchTerm) {
                allFilteredRestaurants = allRestaurants.slice();
            } else {
                var term = searchTerm.toLowerCase();
                
                if (category) {
                    // Filter by cuisine category with scoring
                    var scoredRestaurants = allRestaurants.map(function(restaurant) {
                        var cuisineLower = restaurant.cuisine.toLowerCase();
                        var nameLower = restaurant.name.toLowerCase();
                        var descLower = restaurant.description.toLowerCase();
                        
                        var score = 0;
                        var matchesCategory = false;
                        
                        // Check if restaurant matches category keywords
                        for (var i = 0; i < category.keywords.length; i++) {
                            var keyword = category.keywords[i].toLowerCase();
                            
                            // Name contains keyword (highest priority - 600 points)
                            if (nameLower.indexOf(keyword) !== -1) {
                                score += 600;
                                matchesCategory = true;
                            }
                            // Cuisine contains keyword (high priority - 400 points)
                            if (cuisineLower.indexOf(keyword) !== -1) {
                                score += 400;
                                matchesCategory = true;
                            }
                            // Description contains keyword (lower priority - 100 points)
                            if (descLower.indexOf(keyword) !== -1) {
                                score += 100;
                                matchesCategory = true;
                            }
                        }
                        
                        if (matchesCategory) {
                            return {
                                restaurant: restaurant,
                                score: score
                            };
                        }
                        return null;
                    }).filter(function(item) {
                        return item !== null;
                    });
                    
                    // Sort by score (highest first), then by rating
                    scoredRestaurants.sort(function(a, b) {
                        // First sort by score
                        if (b.score !== a.score) {
                            return b.score - a.score;
                        }
                        // If scores are equal, sort by rating
                        var ratingA = parseFloat(a.restaurant.rating) || 0;
                        var ratingB = parseFloat(b.restaurant.rating) || 0;
                        if (ratingB !== ratingA) {
                            return ratingB - ratingA;
                        }
                        // If ratings are equal, sort by number of reviews
                        var reviewsA = parseInt(a.restaurant.reviews.replace(/,/g, '')) || 0;
                        var reviewsB = parseInt(b.restaurant.reviews.replace(/,/g, '')) || 0;
                        return reviewsB - reviewsA;
                    });
                    
                    // Extract just the restaurants
                    allFilteredRestaurants = scoredRestaurants.map(function(item) {
                        return item.restaurant;
                    });
                } else {
                    // Regular search with scoring-based ranking
                    // First, filter and score restaurants
                    var scoredRestaurants = allRestaurants.map(function(restaurant) {
                        var nameLower = restaurant.name.toLowerCase();
                        var cuisineLower = restaurant.cuisine.toLowerCase();
                        var locationLower = restaurant.location.toLowerCase();
                        var descLower = restaurant.description.toLowerCase();
                        
                        var score = 0;
                        var matched = false;
                        
                        // Exact name match (highest priority - 1000 points)
                        if (nameLower === term) {
                            score += 1000;
                            matched = true;
                        }
                        // Name starts with term (very high priority - 800 points)
                        else if (nameLower.indexOf(term) === 0) {
                            score += 800;
                            matched = true;
                        }
                        // Name contains term (high priority - 600 points)
                        else if (nameLower.indexOf(term) !== -1) {
                            score += 600;
                            matched = true;
                        }
                        // Word-based matching in name (check if search term matches any word)
                        else if (term.length >= 3) {
                            var nameWords = nameLower.split(/[\s\(\)]+/);
                            for (var i = 0; i < nameWords.length; i++) {
                                var word = nameWords[i];
                                // Exact word match
                                if (word === term) {
                                    score += 500;
                                    matched = true;
                                    break;
                                }
                                // Word starts with term
                                else if (word.indexOf(term) === 0) {
                                    score += 400;
                                    matched = true;
                                    break;
                                }
                                // Word contains term
                                else if (word.indexOf(term) !== -1) {
                                    score += 300;
                                    matched = true;
                                    break;
                                }
                            }
                        }
                        
                        // Cuisine contains term (medium-high priority - 200 points)
                        if (cuisineLower.indexOf(term) !== -1) {
                            score += 200;
                            matched = true;
                        }
                        
                        // Description contains term (lower priority - 50 points)
                        if (descLower.indexOf(term) !== -1) {
                            score += 50;
                            matched = true;
                        }
                        
                        // Location contains term (lowest priority - 25 points)
                        if (locationLower.indexOf(term) !== -1) {
                            score += 25;
                            matched = true;
                        }
                        
                        // Only return restaurants that matched
                        if (matched) {
                            return {
                                restaurant: restaurant,
                                score: score
                            };
                        }
                        return null;
                    }).filter(function(item) {
                        return item !== null;
                    });
                    
                    // Sort by score (highest first), then by rating
                    scoredRestaurants.sort(function(a, b) {
                        // First sort by score
                        if (b.score !== a.score) {
                            return b.score - a.score;
                        }
                        // If scores are equal, sort by rating
                        var ratingA = parseFloat(a.restaurant.rating) || 0;
                        var ratingB = parseFloat(b.restaurant.rating) || 0;
                        if (ratingB !== ratingA) {
                            return ratingB - ratingA;
                        }
                        // If ratings are equal, sort by number of reviews
                        var reviewsA = parseInt(a.restaurant.reviews.replace(/,/g, '')) || 0;
                        var reviewsB = parseInt(b.restaurant.reviews.replace(/,/g, '')) || 0;
                        return reviewsB - reviewsA;
                    });
                    
                    // Extract just the restaurants
                    allFilteredRestaurants = scoredRestaurants.map(function(item) {
                        return item.restaurant;
                    });
                }
            }
            
            // Sort by rating (highest first) - only if no search term (already sorted in search)
            if (!searchTerm) {
                allFilteredRestaurants = sortRestaurantsByRating(allFilteredRestaurants);
            }
            
            // If we're restoring a page, make sure it's valid for the filtered results
            if (skipPageReset) {
                var totalPages = Math.ceil(allFilteredRestaurants.length / restaurantsPerPage);
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = totalPages;
                } else if (currentPage < 1) {
                    currentPage = 1;
                }
            }
            
            // Reset map interaction flag so map can auto-zoom to new results
            mapUserInteracted = false;
            
            // Render results
            renderRestaurants();
        }
        
        // Global callback for Google Maps API
        window.initGoogleMap = function() {
            if (typeof allRestaurants !== 'undefined') {
                initMap();
            } else {
                // Wait for restaurant data to load
                setTimeout(initGoogleMap, 100);
            }
        };
        
        // Initialize map (Google Maps or Leaflet fallback)
        function initMap() {
            var mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.error('Map container not found');
                return;
            }
            
            // Check if map already initialized
            if (map) {
                return;
            }
            
            // Try Google Maps first
            if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                initGoogleMaps(mapContainer);
                refreshMapMarkers();
            } else if (typeof L !== 'undefined') {
                // Fallback to Leaflet with Google Maps-like styling
                initLeafletMap(mapContainer);
                refreshMapMarkers();
            } else {
                console.error('No map library available');
                // Retry after a delay
                setTimeout(initMap, 500);
            }
        }
        
        // Initialize Google Maps
        function initGoogleMaps(mapContainer) {
            // Initialize Google Map centered on Duluth
            map = new google.maps.Map(mapContainer, {
                center: { lat: 46.7867, lng: -92.1005 },
                zoom: 13,
                styles: [
                    {
                        "featureType": "all",
                        "elementType": "geometry",
                        "stylers": [{"color": "#f5f5f5"}]
                    },
                    {
                        "featureType": "all",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#616161"}]
                    },
                    {
                        "featureType": "all",
                        "elementType": "labels.text.stroke",
                        "stylers": [{"color": "#f5f5f5"}]
                    },
                    {
                        "featureType": "administrative.land_parcel",
                        "elementType": "labels",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "all",
                        "stylers": [{"color": "#ffffff"}]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "all",
                        "stylers": [
                            {"saturation": -100},
                            {"lightness": 45}
                        ]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "all",
                        "stylers": [{"visibility": "simplified"}]
                    },
                    {
                        "featureType": "road.arterial",
                        "elementType": "labels.icon",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "all",
                        "stylers": [
                            {"color": "#b3d9ff"},
                            {"visibility": "on"}
                        ]
                    }
                ],
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_CENTER
                }
            });
            
            // Track user interaction (zoom and pan)
            google.maps.event.addListener(map, 'zoom_changed', function() {
                mapUserInteracted = true;
            });
            google.maps.event.addListener(map, 'dragend', function() {
                mapUserInteracted = true;
            });
        }
        
        // Initialize Leaflet map with Google Maps-like styling (fallback)
        function initLeafletMap(mapContainer) {
            // Initialize Leaflet map centered on Duluth
            map = L.map(mapContainer).setView([46.7867, -92.1005], 13);
            map.attributionControl.setPrefix('');
            
            // Use a light-themed basemap that closely matches Google Maps styling
            var isRetina = window.devicePixelRatio > 1;
            var cartoUrl = isRetina
                ? 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png'
                : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png';
            
            L.tileLayer(cartoUrl, {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            setTimeout(function() {
                if (map && typeof map.invalidateSize === 'function') {
                    map.invalidateSize();
                }
            }, 200);
            
            // Track user interaction (zoom and pan)
            map.on('zoomend', function() {
                mapUserInteracted = true;
            });
            map.on('dragend', function() {
                mapUserInteracted = true;
            });
        }
        
        // Update map with restaurant locations
        function updateMap(restaurants, startIndex) {
            if (!map) {
                initMap();
                if (!map) return;
            }
            
            // Use provided startIndex or calculate from current page
            if (startIndex === undefined) {
                startIndex = (currentPage - 1) * restaurantsPerPage;
            }
            
            if (restaurants.length === 0) {
                // Clear markers
                if (typeof google !== 'undefined' && google.maps) {
                    googleMarkers.forEach(function(marker) {
                        marker.setMap(null);
                    });
                    googleMarkers = [];
                } else if (typeof L !== 'undefined') {
                    markers.forEach(function(marker) {
                        map.removeLayer(marker);
                    });
                    markers = [];
                }
                return;
            }
            
            // Check if using Google Maps or Leaflet
            if (typeof google !== 'undefined' && google.maps && map instanceof google.maps.Map) {
                updateGoogleMap(restaurants, startIndex);
            } else if (typeof L !== 'undefined' && map instanceof L.Map) {
                updateLeafletMap(restaurants, startIndex);
            }
        }
        
        function refreshMapMarkers() {
            if (!Array.isArray(allFilteredRestaurants) || allFilteredRestaurants.length === 0 || !map) {
                return;
            }
            
            var startIndex = (currentPage - 1) * restaurantsPerPage;
            var endIndex = startIndex + restaurantsPerPage;
            var pageRestaurants = allFilteredRestaurants.slice(startIndex, endIndex);
            if (pageRestaurants.length === 0) {
                return;
            }
            
            updateMap(pageRestaurants, startIndex);
        }
        
        // Update Google Maps with markers
        function updateGoogleMap(restaurants, startIndex) {
            // Clear existing markers
            googleMarkers.forEach(function(marker) {
                marker.setMap(null);
            });
            googleMarkers = [];
            
            var bounds = new google.maps.LatLngBounds();
            
            restaurants.forEach(function(restaurant, index) {
                var coords = getRestaurantCoordinates(restaurant);
                var position = new google.maps.LatLng(coords.lat, coords.lng);
                bounds.extend(position);
                
                var markerNumber = startIndex + index + 1;
                
                var markerIcon = {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 15,
                    fillColor: '#d32f2f',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3,
                    labelOrigin: new google.maps.Point(0, 0)
                };
                
                var marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: markerIcon,
                    label: {
                        text: markerNumber.toString(),
                        color: '#ffffff',
                        fontSize: '13px',
                        fontWeight: 'bold'
                    },
                    title: restaurant.name
                });
                
                var addressDisplay = restaurant.address && restaurant.address !== 'N/A' 
                    ? restaurant.address 
                    : restaurant.location;
                
                var infoWindow = new google.maps.InfoWindow({
                    content: '<div style="min-width: 200px; padding: 4px;">' +
                        '<strong style="font-size: 1.1rem; color: #1e3a5f; display: block; margin-bottom: 6px;">' + 
                        restaurant.name + '</strong>' +
                        '<div style="color: #64748b; font-size: 0.9rem; margin-bottom: 4px;">' +
                        '<span style="color: #f97316; font-weight: 600;">' + restaurant.rating + ' ⭐</span> (' + restaurant.reviews + ' reviews)' +
                        '</div>' +
                        '<div style="color: #64748b; font-size: 0.85rem;">' +
                        '📍 ' + addressDisplay + ' • ' + restaurant.price +
                        '</div>' +
                        '</div>'
                });
                
                marker.addListener('click', function() {
                    infoWindow.open(map, marker);
                });
                
                googleMarkers.push(marker);
            });
            
            if (googleMarkers.length > 0) {
                // Only auto-zoom if user hasn't manually interacted with the map
                if (!mapUserInteracted) {
                    // Fit bounds to show all markers with minimal padding to zoom in as much as possible
                    if (googleMarkers.length === 1) {
                        // Single marker - zoom in very close
                        map.setCenter(bounds.getCenter());
                        map.setZoom(17);
                    } else {
                        // Multiple markers - fit bounds with minimal padding for maximum zoom
                        map.fitBounds(bounds, { padding: 20 });
                    }
                }
            }
        }
        
        // Update Leaflet map with markers (fallback)
        function updateLeafletMap(restaurants, startIndex) {
            // Clear existing markers
            markers.forEach(function(marker) {
                map.removeLayer(marker);
            });
            markers = [];
            
            var bounds = [];
            
            restaurants.forEach(function(restaurant, index) {
                var coords = getRestaurantCoordinates(restaurant);
                bounds.push([coords.lat, coords.lng]);
                
                var markerNumber = startIndex + index + 1;
                
                var markerHtml =
                    '<div style="position: relative; width: 38px; height: 48px;">' +
                        '<div style="' +
                            'background: linear-gradient(135deg, #4a8ffe 0%, #1a66ff 100%);' +
                            'border-radius: 50%;' +
                            'width: 38px;' +
                            'height: 38px;' +
                            'display: flex;' +
                            'align-items: center;' +
                            'justify-content: center;' +
                            'color: #ffffff;' +
                            'font-weight: 700;' +
                            'font-size: 14px;' +
                            'border: 3px solid #ffffff;' +
                            'box-shadow: 0 6px 14px rgba(26, 102, 255, 0.35);' +
                        '">' + markerNumber + '</div>' +
                        '<div style="' +
                            'position: absolute;' +
                            'left: 50%;' +
                            'bottom: 6px;' +
                            'width: 16px;' +
                            'height: 16px;' +
                            'background: linear-gradient(135deg, #4a8ffe 0%, #1a66ff 100%);' +
                            'transform: translate(-50%, 50%) rotate(45deg);' +
                            'border-radius: 2px;' +
                            'border-left: 3px solid #ffffff;' +
                            'border-top: 3px solid #ffffff;' +
                            'box-shadow: 0 6px 14px rgba(26, 102, 255, 0.35);' +
                        '"></div>' +
                    '</div>';
                
                var customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: markerHtml,
                    iconSize: [38, 52],
                    iconAnchor: [19, 46]
                });
                
                var addressDisplay = restaurant.address && restaurant.address !== 'N/A' 
                    ? restaurant.address 
                    : restaurant.location;
                
                var marker = L.marker([coords.lat, coords.lng], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(
                        '<div style="min-width: 200px;">' +
                        '<strong style="font-size: 1.1rem; color: #1e3a5f; display: block; margin-bottom: 6px;">' + restaurant.name + '</strong>' +
                        '<div style="color: #64748b; font-size: 0.9rem; margin-bottom: 4px;">' +
                        '<span style="color: #f97316; font-weight: 600;">' + restaurant.rating + ' ⭐</span> (' + restaurant.reviews + ' reviews)' +
                        '</div>' +
                        '<div style="color: #64748b; font-size: 0.85rem;">' +
                        '📍 ' + addressDisplay + ' • ' + restaurant.price +
                        '</div>' +
                        '</div>'
                    );
                
                markers.push(marker);
            });
            
            if (bounds.length > 0) {
                // Only auto-zoom if user hasn't manually interacted with the map
                if (!mapUserInteracted) {
                    // Fit bounds to show all markers with minimal padding for maximum zoom
                    if (bounds.length === 1) {
                        // Single marker - zoom in very close
                        map.setView(bounds[0], 17);
                    } else {
                        // Multiple markers - fit bounds with minimal padding for maximum zoom
                        var boundsObj = L.latLngBounds(bounds);
                        map.fitBounds(boundsObj, { padding: [20, 20] });
                    }
                }
            }
        }
        
        // Make doSearch globally accessible
        window.doSearch = doSearch;
        
        // Restaurant detail page function
        window.openRestaurant = function(name, number, rating, reviews, price, cuisine, description, image, location, phone, website, address, reservations, popularDishes, hours) {
            var params = new URLSearchParams();
            params.set('name', name);
            params.set('number', number);
            params.set('rating', rating);
            params.set('reviews', reviews);
            params.set('price', price);
            params.set('cuisine', cuisine);
            params.set('description', description);
            params.set('image', image);
            params.set('location', location || 'Duluth');
            if (phone) params.set('phone', phone);
            if (website) params.set('website', website);
            if (address) params.set('address', address);
            if (reservations) params.set('reservations', reservations);
            if (popularDishes) params.set('popularDishes', popularDishes);
            if (hours) params.set('hours', hours); // Already encoded
            
            // Preserve current page and search term
            params.set('returnPage', currentPage);
            var searchInput = document.getElementById('restaurantSearch');
            if (searchInput && searchInput.value.trim()) {
                params.set('returnSearch', searchInput.value.trim());
            }
            
            window.location.href = 'restaurant-template.html?' + params.toString();
        };
        
        // Initialize page when DOM is ready
        function initRestaurantsPage() {
            var searchInput = document.getElementById('restaurantSearch');
            var searchButton = document.getElementById('searchButton');
            var prevBtn = document.getElementById('prevPage');
            var nextBtn = document.getElementById('nextPage');
            
            if (!searchInput) {
                console.error('Search input not found');
                return;
            }
            
            // Check if data is loaded
            if (typeof allRestaurants === 'undefined') {
                setTimeout(initRestaurantsPage, 100);
                return;
            }
            
            // Start pre-geocoding all addresses in the background
            preGeocodeAllRestaurants();
            
            // Initialize map
            initMap();
            
            // Attach vote button listeners (will be re-attached when restaurants render, but ensure it's set up)
            attachVoteButtonListeners();
            
            // Set up search input event listeners - only search on Enter
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    doSearch();
                }
            });
            
            // Set up search button
            if (searchButton) {
                searchButton.addEventListener('click', doSearch);
            }
            
            // Set up pagination buttons
            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    goToPage(currentPage - 1);
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    goToPage(currentPage + 1);
                });
            }
            
            // Check for URL parameters
            var urlParams = new URLSearchParams(window.location.search);
            var searchParam = urlParams.get('search');
            var cuisineParam = urlParams.get('cuisine');
            var returnPage = urlParams.get('returnPage');
            var returnSearch = urlParams.get('returnSearch');
            
            // Restore page number if returning from restaurant detail page
            var isRestoringPage = false;
            if (returnPage) {
                var pageNum = parseInt(returnPage, 10);
                if (pageNum > 0) {
                    currentPage = pageNum;
                    isRestoringPage = true;
                }
            }
            
            if (returnSearch) {
                // Restore search term and page when returning from restaurant detail
                searchInput.value = returnSearch;
                doSearch(true); // Skip page reset since we're restoring
            } else if (searchParam) {
                searchInput.value = searchParam;
                doSearch(isRestoringPage); // Preserve page if restoring
            } else if (cuisineParam) {
                // Handle cuisine category from URL
                var categoryKey = cuisineParam.replace(/-/g, ' ');
                for (var key in cuisineCategories) {
                    var category = cuisineCategories[key];
                    if (category.name.toLowerCase() === categoryKey || category.plural.toLowerCase() === categoryKey) {
                        searchInput.value = category.keywords[0];
                        doSearch(isRestoringPage); // Preserve page if restoring
                        return;
                    }
                }
                // Fallback
                searchInput.value = cuisineParam.replace(/-/g, ' ');
                doSearch(isRestoringPage); // Preserve page if restoring
            } else {
                // Initial render - show all restaurants sorted by rating
                doSearch(isRestoringPage); // Preserve page if restoring
            }
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initRestaurantsPage);
        } else {
            initRestaurantsPage();
        }
    </script>
</body>
</html>
